<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Digital - SMAN 1 Dramaga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        /* Style untuk Modal */
        .modal-overlay {
            display: none; /* Sembunyikan secara default */
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        /* Style untuk mencetak */
        @media print {
            body {
                background-color: white;
            }
            /* Sembunyikan semua elemen kecuali area laporan */
            body > div > *:not(#admin-view),
            #admin-view button,
            #admin-view .p-6.md\:p-8.bg-pink-600,
            #admin-view .mb-4, /* Sembunyikan search bar */
            .non-printable,
            footer {
                display: none !important;
            }
            #admin-view, #admin-view > div {
                display: block !important;
                box-shadow: none;
                border: none;
            }
            #tabelPerKelasContainer {
                margin-top: -4rem; /* Sesuaikan posisi agar lebih ke atas */
            }
            h1.text-2xl {
                color: black !important;
                text-align: left;
            }
            p.text-center {
                text-align: left;
            }
            img {
                max-width: 96px !important; /* Pastikan gambar tidak terlalu besar saat dicetak */
            }
        }
    </style>
</head>
<body class="bg-pink-100 flex items-center justify-center min-h-screen py-8">
    <div class="w-full max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        
        <!-- Tampilan Awal: Pemilihan Peran -->
        <div id="role-selection" class="text-center bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-pink-800">Selamat Datang di Absensi SMAN 1 Dramaga</h1>
            <p class="text-gray-600 mt-2 mb-8">Silakan pilih peran Anda untuk melanjutkan.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="showView('password-view')" class="w-full sm:w-auto bg-pink-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-pink-700 transition duration-150 ease-in-out shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Masuk sebagai Admin</span>
                </button>
                <button onclick="showView('student-view')" class="w-full sm:w-auto bg-pink-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-pink-700 transition duration-150 ease-in-out shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <span>Masuk sebagai Siswa</span>
                </button>
            </div>
        </div>
        
        <!-- Tampilan Password Admin -->
        <div id="password-view" class="view">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                <h2 class="text-2xl font-bold text-pink-800 mb-4">Verifikasi Admin</h2>
                <p class="text-gray-600 mb-6">Silakan masukkan kata sandi untuk melanjutkan.</p>
                <div class="w-full max-w-xs mx-auto">
                    <input type="password" id="adminPassword" placeholder="Kata Sandi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 ease-in-out text-center">
                    <p id="password-error" class="text-red-500 text-sm mt-2 h-5"></p>
                    <button onclick="checkAdminPassword()" class="w-full mt-2 bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition duration-150 ease-in-out shadow-md">
                        Masuk
                    </button>
                </div>
            </div>
             <button onclick="showView('role-selection')" class="mt-4 w-full text-pink-600 font-semibold hover:underline non-printable">Kembali ke Pilihan Peran</button>
        </div>


        <!-- Tampilan Siswa -->
        <div id="student-view" class="view">
            <div class="bg-pink-50 rounded-2xl shadow-lg overflow-hidden">
                <div class="p-6 md:p-8 bg-pink-600 text-white">
                    <h1 class="text-2xl sm:text-3xl font-bold text-center">Formulir Absensi Siswa</h1>
                    <p class="text-center text-pink-200 mt-1">SMAN 1 Dramaga</p>
                </div>
                <div class="p-6 md:p-8">
                    <div id="info-sekolah-display" class="mb-6 p-4 border-l-4 border-pink-600 bg-pink-100 rounded-r-lg">
                        <h2 class="text-lg font-bold text-pink-800 mb-2">INFORMASI SEKOLAH HARI INI!</h2>
                        <p id="info-sekolah-content" class="text-gray-700 text-sm whitespace-pre-wrap">Memuat informasi...</p>
                    </div>
                    <form id="form-absensi" class="space-y-6">
                        <div>
                            <label for="namaSiswa" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap Siswa</label>
                            <input type="text" id="namaSiswa" name="namaSiswa" placeholder="Masukkan nama lengkap Anda" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div>
                            <label for="kelasSiswa" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="kelasSiswa" name="kelasSiswa" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                                <option value="" disabled selected>-- Pilih Kelas --</option>
                            </select>
                        </div>
                        <div>
                            <label for="statusKehadiran" class="block text-sm font-medium text-gray-700 mb-2">Status Kehadiran</label>
                            <select id="statusKehadiran" name="statusKehadiran" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                                <option value="Hadir" selected>Hadir</option>
                                <option value="Izin">Izin</option>
                                <option value="Sakit">Sakit</option>
                                <option value="Alfa">Alfa</option>
                            </select>
                        </div>
                        <div>
                            <label for="alasanKehadiran" class="block text-sm font-medium text-gray-700 mb-2">Alasan (wajib diisi jika Izin atau Sakit)</label>
                            <textarea id="alasanKehadiran" name="alasanKehadiran" rows="3" placeholder="Contoh: Ada acara keluarga / Sedang demam" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></textarea>
                        </div>
                        <div>
                            <label for="fileFoto" class="block text-sm font-medium text-gray-700 mb-2">Kirim Bukti Foto (jika ada)</label>
                            <input type="file" id="fileFoto" name="fileFoto" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200">
                        </div>
                        <button type="button" id="submit-button" onclick="catatKehadiran()" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition shadow-md">
                            Catat Kehadiran
                        </button>
                    </form>
                    <div id="pesan-sukses" class="hidden mt-6 p-4 bg-green-100 text-green-800 rounded-lg text-center">
                        Kehadiran berhasil dicatat!
                    </div>
                </div>
            </div>
             <button onclick="showView('role-selection')" class="mt-4 w-full text-pink-600 font-semibold hover:underline non-printable">Kembali ke Pilihan Peran</button>
        </div>

        <!-- Tampilan Admin -->
        <div id="admin-view" class="view">
             <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-6 md:p-8 bg-pink-600 text-white">
                    <h1 class="text-2xl sm:text-3xl font-bold text-center">Halaman Admin</h1>
                    <p class="text-center text-pink-200 mt-1">Riwayat Absensi Hari Ini</p>
                </div>
                <div class="p-6 md:p-8">
                    <div class="non-printable flex flex-col sm:flex-row gap-3 mb-6">
                        <button onclick="bukaModal('infoSekolahModal')" class="flex-1 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">Informasi Sekolah</button>
                        <button onclick="cetakLaporan()" class="flex-1 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Cetak Laporan</button>
                        <button onclick="bukaModal('hapusDataModal')" class="flex-1 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Hapus Data Hari Ini</button>
                    </div>
                    <div class="mb-4">
                        <label for="searchInput" class="sr-only">Cari Nama Siswa</label>
                        <input type="text" id="searchInput" onkeyup="tampilkanRiwayat(this.value)" placeholder="Cari berdasarkan nama siswa..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    </div>
                    <div id="tabelPerKelasContainer">
                        <!-- Tabel per kelas akan dimuat di sini -->
                    </div>
                </div>
            </div>
            <button onclick="showView('role-selection')" class="mt-4 w-full text-pink-600 font-semibold hover:underline non-printable">Kembali ke Pilihan Peran</button>
        </div>
        
        <footer class="text-center mt-6 text-sm text-gray-500 non-printable">
            <p>&copy; 2024 SMAN 1 Dramaga. Dibuat untuk mempermudah absensi.</p>
        </footer>
    </div>
    
    <!-- Modal Informasi Sekolah -->
    <div id="infoSekolahModal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Informasi & Kebijakan Sekolah</h3>
            <textarea id="infoSekolahText" class="w-full h-40 p-2 border rounded-md" placeholder="Tuliskan informasi atau kebijakan absensi di sini."></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button onclick="tutupModal('infoSekolahModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Tutup</button>
                <button onclick="simpanInfoSekolah()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus Data -->
    <div id="hapusDataModal" class="modal-overlay">
         <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Anda Yakin?</h3>
            <p class="text-gray-600 mb-6">Semua data absensi hari ini akan dihapus secara permanen.</p>
            <div class="flex justify-center gap-4">
                <button onclick="tutupModal('hapusDataModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Batal</button>
                <button onclick="konfirmasiHapusData()" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal Hubungi Orang Tua -->
    <div id="kontakOrtuModal" class="modal-overlay">
         <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Hubungi Orang Tua</h3>
            <p class="text-gray-600 mb-4">Kirim notifikasi untuk <strong id="namaSiswaKontak" class="text-pink-700"></strong>.</p>
            <div>
                <label for="nomorHp" class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp Orang Tua</label>
                <input type="tel" id="nomorHp" placeholder="Contoh: 6281234567890" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500">
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="tutupModal('kontakOrtuModal')" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                <button onclick="kirimPesanWhatsApp()" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.89 7.89 0 0 0 13.6 2.326zM7.994 14.521a6.57 6.57 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.1-.836-.414-1.077-.484-.24-.07-.414-.1-.588.1-.174.2-.646.812-.791.976-.144.164-.288.184-.53.084-.24-.1-.963-.36-1.826-1.125-.672-.596-1.125-1.326-1.26-1.555-.144-.229-.015-.35.084-.448.09-.09.197-.24.296-.36.1-.12.134-.2.197-.33.065-.134.034-.248-.015-.347-.05-.1-.414-.983-.562-1.34-.148-.36-.296-.302-.414-.302h-.174c-.134 0-.347.034-.52.164-.174.134-.646.623-.646 1.524 0 .9.662 1.769.752 1.889.09.12.964 1.482 2.344 2.058.33.136.59.216.787.274.24.072.458.06.612-.036.174-.1.836-.542.953-1.07.118-.53.118-.984.084-1.07z"/></svg>
                    Kirim via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        // PENTING: Ganti nilai di bawah ini dengan URL dan Kunci Anon dari proyek Supabase Anda.
        const SUPABASE_URL = 'https://dsfweltfzcbjalmdfmoh.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzZndlbHRmemNiamFsbWRmbW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzODczMjMsImV4cCI6MjA3NTk2MzMyM30.MvBu7sQVUxf3hwZ7PjZj0v6IuRLYSouOWFdGCMlodeg';

        // Inisialisasi klien Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DATA ---
        let absensiSiswa = [];
        let siswaUntukKontak = { nama: '', status: '' };
        let criticalError = false;
        
        // --- FUNGSI ---
        function handleMissingTableError() {
            if (criticalError) return;
            criticalError = true;
            document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center p-4">
                <div class="text-center p-8 bg-red-100 text-red-800 rounded-lg shadow-lg max-w-2xl">
                    <h2 class="text-2xl font-bold mb-4">Kesalahan Konfigurasi Database</h2>
                    <p class="mb-2">Aplikasi tidak dapat menemukan tabel <strong>'absensi'</strong> atau <strong>'informasi_sekolah'</strong> di database Supabase Anda.</p>
                    <p>Ini biasanya terjadi karena skrip SQL untuk membuat tabel belum dijalankan.</p>
                    <p class="mt-4"><strong>Solusi:</strong> Silakan buka file <strong>panduan_supabase.md</strong>, salin kode SQL dari Langkah 4, dan jalankan di SQL Editor proyek Supabase Anda. Setelah itu, segarkan kembali halaman ini.</p>
                </div>
            </div>`;
        }
        
        async function loadAbsensiData() {
            if (criticalError) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const { data, error } = await supabaseClient
                .from('absensi')
                .select('*')
                .gte('created_at', today.toISOString());

            if (error) {
                console.error('Error mengambil data absensi:', error);
                if (error.code === 'PGRST116' || error.code === 'PGRST205') {
                    handleMissingTableError();
                }
                return Promise.reject(error); // Menolak promise jika ada error
            }
            absensiSiswa = data;
            return Promise.resolve(); // Menyelesaikan promise jika berhasil
        }
        
        async function loadInfoSekolah() {
            if (criticalError) return;
            const { data, error } = await supabaseClient
                .from('informasi_sekolah')
                .select('konten')
                .eq('id', 1)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Error mengambil info sekolah:', error);
                if (error.code === 'PGRST205') {
                    handleMissingTableError();
                }
                return Promise.reject(error);
            }

            if(data) {
                const infoSekolahText = document.getElementById('infoSekolahText');
                const infoSekolahContent = document.getElementById('info-sekolah-content');
                if (infoSekolahText) infoSekolahText.value = data.konten;
                if (infoSekolahContent) infoSekolahContent.textContent = data.konten || 'Tidak ada informasi terbaru.';
            } else {
                 const infoSekolahContent = document.getElementById('info-sekolah-content');
                 if (infoSekolahContent) infoSekolahContent.textContent = 'Tidak ada informasi terbaru.';
            }
            return Promise.resolve();
        }
        
        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === "2007") {
                showView('admin-view');
            } else {
                document.getElementById('password-error').textContent = 'Kata sandi salah!';
            }
        }
        
        async function showView(viewId) {
            if (criticalError) return;
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            
            const roleSelection = document.getElementById('role-selection');
            if (roleSelection) roleSelection.style.display = 'none';
            
            const adminPassword = document.getElementById('adminPassword');
            if (adminPassword) adminPassword.value = '';

            const passwordError = document.getElementById('password-error');
            if(passwordError) passwordError.textContent = '';
            
            const viewToShow = document.getElementById(viewId);
            if(viewToShow) viewToShow.style.display = 'block';

            if (viewId === 'admin-view' || viewId === 'student-view') {
                const spinner = '<p class="text-center text-gray-500 py-4">Memuat data...</p>';
                if(viewId === 'admin-view') {
                    const container = document.getElementById('tabelPerKelasContainer');
                    if (container) container.innerHTML = spinner;
                }
                
                try {
                    await loadAbsensiData();
                    await loadInfoSekolah();
                } catch (error) {
                    // Penanganan error sudah dilakukan di dalam fungsi load
                    return; 
                }

                if (criticalError) return;

                if(viewId === 'admin-view') {
                    const searchInput = document.getElementById('searchInput');
                    if(searchInput) searchInput.value = '';
                    tampilkanRiwayat();
                }
            }
        }

        function buatOpsiKelas() {
            const selectKelas = document.getElementById('kelasSiswa');
            if(!selectKelas || selectKelas.options.length > 1) return; 

            const jurusan = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
            for (let tingkat = 10; tingkat <= 12; tingkat++) {
                jurusan.forEach(j => {
                    const namaKelas = `${tingkat} ${j}`;
                    const option = document.createElement('option');
                    option.value = namaKelas;
                    option.textContent = namaKelas;
                    selectKelas.appendChild(option);
                });
            }
        }

        function tampilkanRiwayat(filterNama = '') {
            if (criticalError) return;
            const container = document.getElementById('tabelPerKelasContainer');
            if (!container) return;
            container.innerHTML = ''; 

            if (!absensiSiswa || absensiSiswa.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada data absensi hari ini.</p>';
                return;
            }

            const dataTersaring = absensiSiswa.filter(data =>
                data.nama.toLowerCase().includes(filterNama.toLowerCase())
            );

            if (dataTersaring.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Data siswa tidak ditemukan.</p>';
                return;
            }

            const dataPerKelas = dataTersaring.reduce((acc, data) => {
                (acc[data.kelas] = acc[data.kelas] || []).push(data);
                return acc;
            }, {});

            Object.keys(dataPerKelas).sort().forEach(kelas => {
                container.innerHTML += `<h3 class="text-xl font-bold text-pink-700 mt-6 mb-3">Kelas: ${kelas}</h3>`;
                const tableContainer = document.createElement('div');
                tableContainer.className = 'overflow-x-auto border border-gray-200 rounded-lg';
                
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu Absen</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bukti Foto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase non-printable">Tindakan</th>
                        </tr>
                    </thead>`;
                
                const tbody = document.createElement('tbody');
                tbody.className = 'bg-white divide-y divide-gray-200';
                
                dataPerKelas[kelas].forEach((data, index) => {
                    const statusBadges = {
                        Hadir: '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Hadir</span>',
                        Izin: '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Izin</span>',
                        Sakit: '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Sakit</span>',
                        Alfa: '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">Alfa</span>'
                    };
                    const fotoCell = (data.foto && data.foto.startsWith('data:image'))
                        ? `<img src="${data.foto}" alt="Bukti" class="w-24 h-24 object-cover rounded-md">` : '-';
                    
                    const waktu = data.status !== 'Alfa' && data.waktu ? new Date(data.waktu).toLocaleTimeString('id-ID') : '--:--:--';

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${data.nama}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${waktu}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${statusBadges[data.status] || data.status}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${fotoCell}</td>
                            <td class="px-6 py-4 text-sm font-medium non-printable">
                                <button onclick="bukaModalKontak('${data.nama}', '${data.status}')" class="text-indigo-600 hover:text-indigo-900">Hubungi Ortu</button>
                            </td>
                        </tr>`;
                });
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                container.appendChild(tableContainer);
            });
        }

        async function catatKehadiran() {
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';

            const nama = document.getElementById('namaSiswa').value.trim();
            const kelas = document.getElementById('kelasSiswa').value;
            const status = document.getElementById('statusKehadiran').value;
            const alasan = document.getElementById('alasanKehadiran').value.trim();
            const fotoFile = document.getElementById('fileFoto').files[0];

            if (!nama || !kelas) {
                alert('Nama dan Kelas wajib diisi!');
                submitButton.disabled = false;
                submitButton.textContent = 'Catat Kehadiran';
                return;
            }

            let urlFoto = null;
            if (fotoFile) {
                const reader = new FileReader();
                urlFoto = await new Promise(resolve => {
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(fotoFile);
                });
            }

            const dataBaru = {
                nama, kelas, status, alasan, 
                foto: urlFoto,
                waktu: status !== 'Alfa' ? new Date().toISOString() : null
            };

            const { error } = await supabaseClient.from('absensi').insert([dataBaru]);

            if (error) {
                console.error('Gagal menyimpan absensi:', error);
                alert('Terjadi kesalahan saat menyimpan data.');
            } else {
                document.getElementById('pesan-sukses').classList.remove('hidden');
                setTimeout(() => document.getElementById('pesan-sukses').classList.add('hidden'), 3000);
                document.getElementById('form-absensi').reset();
                await loadAbsensiData(); // Muat ulang data
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Catat Kehadiran';
        }
        
        function cetakLaporan() { window.print(); }

        async function konfirmasiHapusData() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const { error } = await supabaseClient
                .from('absensi')
                .delete()
                .gte('created_at', today.toISOString());
            
            if (error) {
                alert('Gagal menghapus data.');
                console.error(error);
            } else {
                absensiSiswa = [];
                tampilkanRiwayat();
            }
            tutupModal('hapusDataModal');
        }

        async function simpanInfoSekolah() {
            const konten = document.getElementById('infoSekolahText').value;
            const { error } = await supabaseClient
                .from('informasi_sekolah')
                .upsert({ id: 1, konten: konten });

            if (error) {
                alert('Gagal menyimpan informasi.');
                console.error(error);
            } else {
                document.getElementById('info-sekolah-content').textContent = konten || 'Tidak ada informasi terbaru.';
            }
            tutupModal('infoSekolahModal');
        }

        function kirimPesanWhatsApp() {
            let nomorHp = document.getElementById('nomorHp').value.trim();
            if (!nomorHp) { alert('Nomor WhatsApp tidak boleh kosong.'); return; }
            if (nomorHp.startsWith('0')) nomorHp = '62' + nomorHp.substring(1);

            const { nama, status } = siswaUntukKontak;
            const pesan = `Yth. Bapak/Ibu Wali Murid dari ${nama},\n\nKami dari SMAN 1 Dramaga ingin menginformasikan bahwa ananda tercatat *${status}* pada hari ini.\n\nTerima kasih.`;
            window.open(`https://wa.me/${nomorHp}?text=${encodeURIComponent(pesan)}`, '_blank');
            tutupModal('kontakOrtuModal');
        }
        
        function bukaModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function tutupModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function bukaModalKontak(nama, status) {
            siswaUntukKontak = { nama, status };
            document.getElementById('namaSiswaKontak').textContent = nama;
            document.getElementById('nomorHp').value = '';
            bukaModal('kontakOrtuModal');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (SUPABASE_URL === 'URL_SUPABASE_ANDA' || SUPABASE_ANON_KEY === 'KUNCI_ANON_SUPABASE_ANDA') {
                document.body.innerHTML = '<div class="text-center p-8 bg-red-100 text-red-800 rounded-lg"><strong>PENTING:</strong> Konfigurasi Supabase belum diatur. Silakan buka file HTML ini di editor teks, masukkan URL dan Kunci Anon Supabase Anda, lalu segarkan halaman. Ikuti panduan pada file `panduan_supabase.md`.</div>';
                return;
            }
            buatOpsiKelas();
            showView('role-selection');
        });
    </script>
</body>
</html>

